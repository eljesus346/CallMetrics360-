<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon-icon.png">
    <title>Reportes y Control Call Center</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(12px);
            padding: 25px 30px;
            border-radius: 16px;
            margin-bottom: 35px;
            text-align: center;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .header h1 {
            color: white;
            font-size: 34px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .header-buttons {
            display: flex;
            justify-content: center;
            gap: 18px;
            flex-wrap: wrap;
        }
        .btn, .refresh-btn {
            padding: 13px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15.5px;
            font-weight: 600;
            transition: all 0.35s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn.primary:hover { transform: translateY(-4px) scale(1.05); box-shadow: 0 12px 30px rgba(102, 126, 234, 0.6); }
        .btn.secondary {
            background: rgba(255, 255, 255, 0.18);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .btn.secondary:hover { background: rgba(255, 255, 255, 0.32); transform: translateY(-3px); }
        .refresh-btn {
            background: #10b981;
            color: white;
            border: none;
        }
        .refresh-btn:hover { background: #059669; transform: translateY(-3px); }
        .refresh-btn.loading { background: #6ee7b7; cursor: wait; }

        .metrics-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 22px;
            margin-bottom: 35px;
            justify-items: center;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        .metric-card {
            background: rgba(255, 255, 255, 0.96);
            border-radius: 16px;
            padding: 28px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.12);
            transition: all 0.3s;
            width: 100%;
            max-width: 320px;
        }
        .metric-card:hover { transform: translateY(-6px); box-shadow: 0 14px 50px rgba(0,0,0,0.18); }
        .metric-label { color: #555; font-size: 14px; font-weight: 600; text-transform: uppercase; margin-bottom: 12px; }
        .metric-value { font-size: 52px; font-weight: 700; }

        .gauges-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }
        .gauge-card {
            background: rgba(255, 255, 255, 0.96);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.12);
        }
        .gauge-card h3 { text-align: center; color: #333; margin-bottom: 20px; font-size: 18px; }
        .gauge-container { position: relative; width: 100%; height: 200px; }

        .chart-section, .table-container {
            background: rgba(255, 255, 255, 0.96);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 35px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.12);
        }
        .chart-section h2 { color: #333; margin-bottom: 24px; font-size: 24px; }
        .chart-tabs { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
        .tab {
            padding: 12px 24px;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-size: 16px;
            color: #555;
            transition: all 0.3s;
        }
        .tab.active { background: #667eea; color: white; }
        .chart-container { height: 420px; display: none; }
        .chart-container.active { display: block; }

        table { width: 100%; border-collapse: collapse; }
        th { background: #667eea; color: white; padding: 16px; text-align: left; }
        td { padding: 16px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f8fafc; }
        .status-badge { padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; }

        .icon { width: 48px; height: 48px; background: white; border-radius: 12px; display: inline-flex; align-items: center; justify-content: center; font-size: 26px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(239, 68, 68, 0.15);
            padding: 8px 14px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
            color: #ef4444;
        }
        .live-dot {
            width: 10px;
            height: 10px;
            background: #ef4444;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* Loader y error */
        .loader-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 1.2rem;
        }
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #fff;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error-box {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #fee2e2;
            color: #991b1b;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 9998;
            max-width: 90%;
            text-align: center;
        }
        .error-box button {
            margin-top: 10px;
            padding: 8px 16px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .error-box button:hover { background: #dc2626; }

        .last-update {
            text-align: center;
            color: white;
            font-size: 14px;
            margin: -20px 0 25px;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 20px; }
            .header-buttons { flex-direction: column; width: 100%; }
            .btn, .refresh-btn { width: 100%; padding: 14px; font-size: 16px; }
            .chart-tabs { justify-content: center; }
            .metrics-container { max-width: 100%; }
        }

        /* Clases de color para KPIs */
        .metric-value.good    { color: #10b981; }
        .metric-value.warning { color: #f59e0b; }
        .metric-value.danger  { color: #ef4444; }
    </style>
</head>
<body>

    <div class="header">
        <h1>
            
            Reportes y Control Call Center
            <span class="live-indicator">
                <span class="live-dot"></span>
                EN VIVO
            </span>
        </h1>
        <div class="header-buttons">
            <button class="btn primary" onclick="irControl()">üìä Reportes Call Center</button>
            <button class="btn secondary" onclick="irAgentes()">‚è±Ô∏è Control Agentes</button>
            <button class="btn refresh-btn" id="refreshBtn" onclick="refreshData()">
                üîÑ Actualizar Datos
            </button>
        </div>
    </div>

    <!-- Loader global -->
    <div id="globalLoader" class="loader-overlay" style="display: none;">
        <div class="loader-spinner"></div>
        <p>Cargando datos...</p>
    </div>

    <!-- Mensaje de error -->
    <div id="errorMessage" class="error-box" style="display: none;">
        <strong>Error al cargar datos</strong>
        <p id="errorText"></p>
        <button onclick="document.getElementById('errorMessage').style.display='none'">Cerrar</button>
    </div>

    <!-- √öltima actualizaci√≥n -->
    <div class="last-update">
        √öltima actualizaci√≥n: <span id="lastUpdate">‚Äî</span>
    </div>

    <div class="metrics-container">
        <div class="metric-card">
            <div class="metric-label">Llamadas Totales</div>
            <div class="metric-value" id="kpiLlamadas">0</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Llamadas Respondidas</div>
            <div class="metric-value good" id="kpiRespondidas">0</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">% Abandono</div>
            <div class="metric-value" id="kpiAbandono">0%</div>
        </div>
    </div>

    <!-- Veloc√≠metros -->
    <div class="gauges-container">
        <div class="gauge-card">
            <h3>Llamadas Respondidas (Hoy)</h3>
            <div class="gauge-container">
                <canvas id="respondidasGauge"></canvas>
            </div>
        </div>
        <div class="gauge-card">
            <h3>Llamadas Totales (Hoy)</h3>
            <div class="gauge-container">
                <canvas id="totalesGauge"></canvas>
            </div>
        </div>
        <div class="gauge-card">
            <h3>% Abandono (Objetivo: < 15%)</h3>
            <div class="gauge-container">
                <canvas id="abandonGauge"></canvas>
            </div>
        </div>
    </div>

    <div class="chart-section">
        <h2>An√°lisis por Colas (Hoy)</h2>
        <div class="chart-tabs">
            <button class="tab active" onclick="showChart('bar')">üìä Barras</button>
            <button class="tab" onclick="showChart('horizontal')">üìà Horizontales</button>
            <button class="tab" onclick="showChart('donut')">üç© Donut</button>
            <button class="tab" onclick="showChart('stacked')">üìö Apiladas</button>
        </div>
        <div id="chart-bar" class="chart-container active"><canvas id="barChart"></canvas></div>
        <div id="chart-horizontal" class="chart-container"><canvas id="horizontalChart"></canvas></div>
        <div id="chart-donut" class="chart-container"><canvas id="donutChart"></canvas></div>
        <div id="chart-stacked" class="chart-container"><canvas id="stackedChart"></canvas></div>
    </div>

    <div class="table-container">
        <h2 style="margin-bottom: 20px; color: #333;">Detalle por Cola</h2>
        <table>
            <thead>
                <tr>
                    <th>Cola</th>
                    <th>Total</th>
                    <th>Respondidas</th>
                    <th>Abandonadas</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:8000/api";

        let barChart, horizontalChart, donutChart, stackedChart;
        let abandonGauge, respondidasGauge, totalesGauge;

        const colors = {
            primary: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#ff9a9e', '#fad0c4'],
            success: '#10b981',
            danger: '#ef4444',
            warning: '#f59e0b'
        };

        async function cargarDatos(silent = false) {
            const loader = document.getElementById('globalLoader');
            const errorBox = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            const lastUpdateEl = document.getElementById('lastUpdate');

            if (!silent) loader.style.display = 'flex';

            try {
                const res = await fetch(`${API_BASE}/reportes/dashboard`);
                if (!res.ok) {
                    throw new Error(`Error ${res.status}: ${res.statusText}`);
                }

                const { colas, totales } = await res.json();

                document.getElementById("kpiLlamadas").textContent = (totales.llamadas_totales ?? 0).toLocaleString();
                document.getElementById("kpiRespondidas").textContent = (totales.respondidas ?? 0).toLocaleString();

                const abandono = totales.pct_abandonadas ?? 0;
                const kpiAbandonoEl = document.getElementById("kpiAbandono");
                kpiAbandonoEl.textContent = abandono.toFixed(1) + "%";
                kpiAbandonoEl.className = abandono > 20 ? "metric-value danger" :
                                          abandono > 10 ? "metric-value warning" : "metric-value good";

                const tbody = document.getElementById("tableBody");
                tbody.innerHTML = "";
                colas.forEach(q => {
                    const total = q.llamadas_totales || 0;
                    const resp = q.respondidas || 0;
                    const aban = q.abandonadas || 0;

                    const pctAban = total > 0 ? (aban / total * 100) : 0;

                    let abanClass = pctAban < 10 ? "good" : pctAban < 20 ? "warning" : "critical";
                    let abanText = pctAban < 10 ? "Excelente" : pctAban < 20 ? "Atenci√≥n" : "Cr√≠tico";

                    const row = `
                        <tr>
                            <td><strong>${q.cola || 'Sin nombre'}</strong></td>
                            <td>${total.toLocaleString()}</td>
                            <td>${resp.toLocaleString()}</td>
                            <td>${aban.toLocaleString()}</td>
                            <td><span class="status-badge status-${abanClass}">${abanText}</span></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                actualizarGraficos(colas);
                actualizarGauges(totales.llamadas_totales, totales.respondidas, abandono);

                const now = new Date();
                lastUpdateEl.textContent = now.toLocaleString('es-CO', {
                    dateStyle: 'medium',
                    timeStyle: 'short'
                });

                errorBox.style.display = 'none';

            } catch (err) {
                console.error("Error:", err);
                if (!silent) {
                    errorText.textContent = err.message || "No se pudo conectar al servidor. Verifica que el backend est√© corriendo.";
                    errorBox.style.display = 'block';
                }
            } finally {
                if (!silent) loader.style.display = 'none';
            }
        }

        function actualizarGraficos(colas) {
            const labels = colas.map(q => q.cola);
            const totales = colas.map(q => q.llamadas_totales);
            const respondidas = colas.map(q => q.respondidas);
            const abandonadas = colas.map(q => q.abandonadas);

            barChart.data.labels = labels;
            barChart.data.datasets[0].data = respondidas;
            barChart.data.datasets[1].data = abandonadas;
            barChart.update();

            horizontalChart.data.labels = labels;
            horizontalChart.data.datasets[0].data = totales;
            horizontalChart.update();

            donutChart.data.labels = labels;
            donutChart.data.datasets[0].data = totales;
            donutChart.update();

            stackedChart.data.labels = labels;
            stackedChart.data.datasets[0].data = respondidas;
            stackedChart.data.datasets[1].data = abandonadas;
            stackedChart.update();
        }

        function actualizarGauges(totales, respondidas, abandono) {
            const pctRespondidas = totales > 0 ? (respondidas / totales * 100) : 0;
            if (respondidasGauge) respondidasGauge.destroy();
            respondidasGauge = new Chart(document.getElementById('respondidasGauge'), {
                type: 'doughnut',
                data: { datasets: [{ data: [pctRespondidas, 100 - pctRespondidas], backgroundColor: [pctRespondidas > 80 ? '#10b981' : pctRespondidas > 60 ? '#f59e0b' : '#ef4444', '#e5e7eb'], borderWidth: 0, circumference: 180, rotation: 270 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false }, tooltip: { enabled: false } } },
                plugins: [{
                    afterDraw: chart => {
                        const { ctx, chartArea: { width, height } } = chart;
                        ctx.save();
                        ctx.font = 'bold 32px Arial';
                        ctx.fillStyle = '#333';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(`${pctRespondidas.toFixed(1)}%`, width / 2, height / 2 + 10);
                        ctx.font = '14px Arial';
                        ctx.fillStyle = '#666';
                        ctx.fillText('Respondidas', width / 2, height / 2 + 40);
                        ctx.restore();
                    }
                }]
            });

            const maxTotal = 2000;
            if (totalesGauge) totalesGauge.destroy();
            totalesGauge = new Chart(document.getElementById('totalesGauge'), {
                type: 'doughnut',
                data: { datasets: [{ data: [totales, maxTotal - totales], backgroundColor: ['#667eea', '#e5e7eb'], borderWidth: 0, circumference: 180, rotation: 270 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false }, tooltip: { enabled: false } } },
                plugins: [{
                    afterDraw: chart => {
                        const { ctx, chartArea: { width, height } } = chart;
                        ctx.save();
                        ctx.font = 'bold 32px Arial';
                        ctx.fillStyle = '#333';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(`${totales}`, width / 2, height / 2 + 10);
                        ctx.font = '14px Arial';
                        ctx.fillStyle = '#666';
                        ctx.fillText('Totales', width / 2, height / 2 + 40);
                        ctx.restore();
                    }
                }]
            });

            if (abandonGauge) abandonGauge.destroy();
            abandonGauge = new Chart(document.getElementById('abandonGauge'), {
                type: 'doughnut',
                data: { datasets: [{ data: [abandono, 100 - abandono], backgroundColor: [abandono > 20 ? '#ef4444' : abandono > 10 ? '#f59e0b' : '#10b981', '#e5e7eb'], borderWidth: 0, circumference: 180, rotation: 270 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false }, tooltip: { enabled: false } } },
                plugins: [{
                    afterDraw: chart => {
                        const { ctx, chartArea: { width, height } } = chart;
                        ctx.save();
                        ctx.font = 'bold 32px Arial';
                        ctx.fillStyle = '#333';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(`${abandono.toFixed(1)}%`, width / 2, height / 2 + 10);
                        ctx.font = '14px Arial';
                        ctx.fillStyle = '#666';
                        ctx.fillText('Abandono', width / 2, height / 2 + 40);
                        ctx.restore();
                    }
                }]
            });
        }

        function showChart(type) {
            document.querySelectorAll('.chart-container').forEach(c => c.classList.remove('active'));
            document.getElementById(`chart-${type}`).classList.add('active');

            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }

        function refreshData() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('loading');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Actualizando...';

            cargarDatos().then(() => {
                setTimeout(() => {
                    btn.classList.remove('loading');
                    btn.disabled = false;
                    btn.innerHTML = 'üîÑ Actualizar Datos';
                }, 800);
            }).catch(() => {
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.innerHTML = 'üîÑ Actualizar Datos';
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializaci√≥n de gr√°ficos
            barChart = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Respondidas', data: [], backgroundColor: colors.success }, { label: 'Abandonadas', data: [], backgroundColor: colors.danger }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });

            horizontalChart = new Chart(document.getElementById('horizontalChart'), {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Totales', data: [], backgroundColor: colors.primary }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true } } }
            });

            donutChart = new Chart(document.getElementById('donutChart'), {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: colors.primary }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '60%' }
            });

            stackedChart = new Chart(document.getElementById('stackedChart'), {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Respondidas', data: [], backgroundColor: colors.success }, { label: 'Abandonadas', data: [], backgroundColor: colors.danger }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
            });

            cargarDatos();  // Primera carga con loader
            setInterval(() => cargarDatos(true), 15000);  // Refrescos silenciosos cada 15s
        });

        function irControl() { window.location.href = "callcenter.html"; }
        function irAgentes() { window.location.href = "agentes-tiempo.html"; }
    </script>
</body>
</html>